name: E2E Tests
on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS region for deployment'
        default: 'us-east-1'
  pull_request_target:
    branches: [main]

permissions:
  id-token: write # OIDC â€” lets GitHub assume an AWS IAM role via short-lived token (no stored keys)
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    environment: e2e-testing
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      - name: Configure git
        run: |
          git config --global user.email "ci@amazon.com"
          git config --global user.name "CI"
      - uses: astral-sh/setup-uv@v5
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.E2E_AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region || 'us-east-1' }}
      - name: Get AWS Account ID
        id: aws
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> "$GITHUB_OUTPUT"
      - name: Get API keys from Secrets Manager
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            E2E,${{ secrets.E2E_SECRET_ARN }}
          parse-json-secrets: true
      - run: npm ci
      - run: npm run build
      - name: Run E2E tests
        env:
          AWS_ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          AWS_REGION: ${{ inputs.aws_region || 'us-east-1' }}
          ANTHROPIC_API_KEY: ${{ env.E2E_ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ env.E2E_OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ env.E2E_GEMINI_API_KEY }}
        run: npm run test:e2e
